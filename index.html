<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .near-expiry { border: 2px solid #f97316; background-color: #fffaf5; }
        .expired { border: 2px solid #ef4444; background-color: #fef2f2; }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="bg-indigo-950 text-white shadow-2xl sticky top-0 z-[100]">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-400 p-2 rounded-xl text-indigo-950">
                    <i class="fas fa-crown text-xl"></i>
                </div>
                <h1 class="text-xl font-black">Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ±</h1>
            </div>
            <div id="connection-status" class="flex items-center gap-2 text-[10px] bg-white/10 px-3 py-1.5 rounded-full border border-white/20">
                <span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-5xl">
        
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="stat-card bg-white p-5 rounded-[2rem] shadow-sm border-b-4 border-indigo-600">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</p>
                <h3 id="stat-total" class="text-2xl font-black text-slate-800">0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-[2rem] shadow-sm border-b-4 border-orange-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">Ù‚Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</p>
                <h3 id="stat-soon" class="text-2xl font-black text-orange-600">0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-[2rem] shadow-sm border-b-4 border-emerald-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</p>
                <h3 id="stat-profit" class="text-2xl font-black text-emerald-600">$0</h3>
            </div>
            <div class="stat-card bg-white p-5 rounded-[2rem] shadow-sm border-b-4 border-red-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</p>
                <h3 id="stat-expenses" class="text-2xl font-black text-red-600">$0</h3>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div class="bg-gray-200 p-1 rounded-2xl flex">
                <button onclick="changeTab('subs')" id="tab-subs" class="px-6 py-2.5 rounded-xl font-bold text-sm bg-indigo-900 text-white shadow-md">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button>
                <button onclick="changeTab('exps')" id="tab-exps" class="px-6 py-2.5 rounded-xl font-bold text-sm text-gray-500">Ø§Ù„ØµØ±ÙÙŠØ§Øª</button>
            </div>
            <button onclick="openSubModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-black shadow-lg flex items-center gap-2 hover:bg-indigo-700">
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†
            </button>
        </div>

        <!-- Content Area -->
        <div id="view-subs">
            <div class="relative mb-6">
                <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" oninput="render()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø©..." 
                    class="w-full pr-12 pl-4 py-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div id="subs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø³ÙŠØ¸Ù‡Ø±ÙˆÙ† Ù‡Ù†Ø§ -->
            </div>
        </div>

        <div id="view-exps" class="hidden">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
                    <button onclick="openExpModal()" class="bg-red-500 text-white px-4 py-2 rounded-xl text-xs font-bold">Ø¥Ø¶Ø§ÙØ© ØµØ±Ù</button>
                </div>
                <div id="exps-list" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <!-- Sub Modal -->
    <div id="subModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div class="bg-indigo-950 p-6 text-white flex justify-between items-center">
                <h2 id="modalTitle" class="font-black text-xl">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ</h2>
                <button onclick="closeModal('subModal')" class="text-white/50 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="subForm" onsubmit="handleSubSubmit(event)" class="p-8 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="editId">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
                    <input id="in-name" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        <select id="in-service" class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                            <option>ChatGPT</option><option>Netflix</option><option>YouTube</option><option>Canva Pro</option><option>Nitro</option><option>Spotify</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø§Ù„Ù…Ø¯Ø©</label>
                        <select id="in-duration" onchange="calculateDate()" class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                            <option value="1">Ø´Ù‡Ø±ÙŠ (1)</option>
                            <option value="12">Ø³Ù†ÙˆÙŠ (12)</option>
                            <option value="0">Ù…Ø®ØµØµ</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                    <input id="in-email" type="email" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="in-phone" placeholder="Ù…Ø«Ø§Ù„: 0770..." class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø§Ù„Ø³Ø¹Ø± ($)</label>
                        <input id="in-price" type="number" step="0.1" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                        <input id="in-expiry" type="date" required class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 mr-2 uppercase">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="in-paid" class="w-full p-3 bg-gray-50 rounded-xl border outline-none">
                        <option value="true">ÙˆØ§ØµÙ„ âœ…</option>
                        <option value="false">Ù…Ø·Ù„ÙˆØ¨ âŒ</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-indigo-900 text-white py-4 rounded-2xl font-black shadow-xl mt-4">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
            </form>
        </div>
    </div>

    <!-- Exp Modal -->
    <div id="expModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 z-[200]">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="font-black text-xl mb-6 text-center">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
            <form onsubmit="handleExpSubmit(event)" class="space-y-4">
                <input id="ex-title" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†" required class="w-full p-3 bg-gray-50 rounded-xl border">
                <input id="ex-amount" type="number" step="0.1" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº ($)" required class="w-full p-3 bg-gray-50 rounded-xl border">
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸</button>
                    <button type="button" onclick="closeModal('expModal')" class="flex-1 py-3 text-gray-400 font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arin-store-final-pro-v2';

        let subs = [];
        let exps = [];

        // UI Core
        window.changeTab = (tab) => {
            document.getElementById('view-subs').classList.toggle('hidden', tab !== 'subs');
            document.getElementById('view-exps').classList.toggle('hidden', tab !== 'exps');
            document.getElementById('tab-subs').className = tab === 'subs' ? 'px-6 py-2.5 rounded-xl font-bold text-sm bg-indigo-900 text-white shadow-md' : 'px-6 py-2.5 rounded-xl font-bold text-sm text-gray-500';
            document.getElementById('tab-exps').className = tab === 'exps' ? 'px-6 py-2.5 rounded-xl font-bold text-sm bg-indigo-900 text-white shadow-md' : 'px-6 py-2.5 rounded-xl font-bold text-sm text-gray-500';
        };

        window.calculateDate = () => {
            const months = parseInt(document.getElementById('in-duration').value);
            if(months > 0) {
                const now = new Date();
                now.setMonth(now.getMonth() + months);
                document.getElementById('in-expiry').value = now.toISOString().split('T')[0];
            }
        };

        window.openSubModal = (data = null) => {
            document.getElementById('subForm').reset();
            document.getElementById('editId').value = data ? data.id : '';
            document.getElementById('modalTitle').innerText = data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯';
            
            if(data) {
                document.getElementById('in-name').value = data.name;
                document.getElementById('in-service').value = data.service;
                document.getElementById('in-email').value = data.email;
                document.getElementById('in-phone').value = data.phone || '';
                document.getElementById('in-price').value = data.price;
                document.getElementById('in-expiry').value = data.expiry;
                document.getElementById('in-paid').value = data.paid.toString();
            } else {
                calculateDate();
            }
            document.getElementById('subModal').classList.replace('hidden', 'flex');
        };

        window.openExpModal = () => document.getElementById('expModal').classList.replace('hidden', 'flex');
        window.closeModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        // Cloud Storage logic
        async function start() {
            await signInAnonymously(auth);
            document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Ù…ØªØµÙ„ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ âœ…';

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'subs'), (s) => {
                subs = s.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'exps'), (s) => {
                exps = s.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
        }

        window.handleSubSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            let phone = document.getElementById('in-phone').value.trim();
            
            // Auto Format Phone
            if(phone && /^\d+$/.test(phone)) {
                if(phone.startsWith('0')) phone = phone.substring(1);
                if(!phone.startsWith('964')) phone = '964' + phone;
                phone = '+' + phone;
            }

            const data = {
                name: document.getElementById('in-name').value,
                service: document.getElementById('in-service').value,
                email: document.getElementById('in-email').value,
                phone: phone,
                price: parseFloat(document.getElementById('in-price').value),
                expiry: document.getElementById('in-expiry').value,
                paid: document.getElementById('in-paid').value === 'true',
                ts: Date.now()
            };

            const col = collection(db, 'artifacts', appId, 'public', 'data', 'subs');
            id ? await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subs', id), data) : await addDoc(col, data);
            closeModal('subModal');
        };

        window.handleExpSubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'exps'), {
                title: document.getElementById('ex-title').value,
                amount: parseFloat(document.getElementById('ex-amount').value),
                date: new Date().toISOString()
            });
            closeModal('expModal');
        };

        window.deleteItem = async (c, id) => {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', c, id));
        };

        window.sendReminder = (id) => {
            const s = subs.find(x => x.id === id);
            const days = Math.ceil((new Date(s.expiry) - new Date()) / 86400000);
            const msg = `Ø£Ù‡Ù„Ø§Ù‹ ${s.name} âœ¨ØŒ ØªØ°ÙƒÙŠØ± Ù…Ù† Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ± ğŸ‘‘ Ø¨Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ ${s.service}. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${days} ÙŠÙˆÙ…. Ø§Ù„Ù…Ø¨Ù„Øº: $${s.price}`;
            const url = (s.phone && s.phone.includes('+')) ? `https://wa.me/${s.phone.replace('+', '')}?text=${encodeURIComponent(msg)}` : `https://t.me/share/url?url=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        };

        window.render = () => {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('subs-grid');
            const today = new Date();

            const filtered = subs.filter(s => s.name.toLowerCase().includes(q) || s.service.toLowerCase().includes(q));

            grid.innerHTML = filtered.map(s => {
                const diff = Math.ceil((new Date(s.expiry) - today) / 86400000);
                const isNear = diff <= 3 && diff > 0;
                const isExpired = diff <= 0;

                return `
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 relative overflow-hidden ${isExpired ? 'expired' : (isNear ? 'near-expiry' : '')}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-black text-slate-800 text-lg">${s.name}</h4>
                            <p class="text-xs text-indigo-600 font-bold uppercase">${s.service}</p>
                        </div>
                        <div class="text-left">
                            <span class="text-lg font-black text-slate-900">$${s.price}</span>
                            <div class="text-[9px] font-black ${s.paid ? 'text-emerald-500' : 'text-red-500 animate-pulse'}">${s.paid ? 'ÙˆØ§ØµÙ„ âœ…' : 'Ù…Ø·Ù„ÙˆØ¨ âŒ'}</div>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-400 mb-3 truncate font-mono">${s.email}</div>
                    <div class="bg-gray-50/50 p-3 rounded-2xl mb-4 flex justify-between items-center text-xs">
                        <span class="font-bold text-gray-400">ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„:</span>
                        <span class="font-black ${isExpired ? 'text-red-600' : 'text-indigo-900'}">${isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ âš ï¸' : diff + ' ÙŠÙˆÙ…'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="sendReminder('${s.id}')" class="flex-1 bg-indigo-950 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-black">ØªØ°ÙƒÙŠØ±</button>
                        <button onclick='openSubModal(${JSON.stringify(s)})' class="p-2.5 bg-slate-100 text-slate-400 rounded-xl hover:text-indigo-600"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteItem('subs', '${s.id}')" class="p-2.5 bg-slate-100 text-slate-200 rounded-xl hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');

            // Update Stats
            const revenue = subs.filter(s => s.paid).reduce((a, b) => a + b.price, 0);
            const costs = exps.reduce((a, b) => a + b.amount, 0);
            const soonCount = subs.filter(s => {
                const d = Math.ceil((new Date(s.expiry) - today) / 86400000);
                return d > 0 && d <= 3;
            }).length;

            document.getElementById('stat-total').innerText = subs.length;
            document.getElementById('stat-soon').innerText = soonCount;
            document.getElementById('stat-profit').innerText = `$${(revenue - costs).toFixed(1)}`;
            document.getElementById('stat-expenses').innerText = `$${costs.toFixed(1)}`;

            // Exps List
            document.getElementById('exps-list').innerHTML = exps.length ? exps.map(e => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-gray-100">
                    <div>
                        <p class="font-bold text-sm">${e.title}</p>
                        <p class="text-[9px] text-gray-400">${new Date(e.date).toLocaleDateString('ar-EG')}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-red-500">$${e.amount}</span>
                        <button onclick="deleteItem('exps', '${e.id}')" class="text-gray-300 hover:text-red-500"><i class="fas fa-times-circle text-lg"></i></button>
                    </div>
                </div>`).join('') : '<p class="text-center text-gray-300 py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</p>';
        };

        start();
    </script>
</body>
</html>

