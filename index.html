import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  doc, 
  deleteDoc, 
  updateDoc 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Plus, 
  Trash2, 
  MessageCircle, 
  Send, 
  Calendar, 
  Wallet, 
  Clock, 
  AlertCircle,
  TrendingUp
} from 'lucide-react';

// Firebase Configuration
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sub-manager-123';

export default function App() {
  const [user, setUser] = useState(null);
  const [subscriptions, setSubscriptions] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Form State
  const [name, setName] = useState('');
  const [price, setPrice] = useState('');
  const [expiryDate, setExpiryDate] = useState('');
  const [category, setCategory] = useState('Service');

  // 1. Authentication
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // 2. Data Fetching
  useEffect(() => {
    if (!user) return;

    const subsCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'subscriptions');
    const unsubscribe = onSnapshot(subsCollection, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setSubscriptions(docs);
      setLoading(false);
    }, (error) => {
      console.error("Firestore error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  // Actions
  const addSubscription = async (e) => {
    e.preventDefault();
    if (!name || !price || !expiryDate || !user) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'subscriptions'), {
        name,
        price: parseFloat(price),
        expiryDate,
        category,
        createdAt: new Date().toISOString()
      });
      setName('');
      setPrice('');
      setExpiryDate('');
    } catch (err) {
      console.error("Error adding sub:", err);
    }
  };

  const deleteSubscription = async (id) => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'subscriptions', id));
    } catch (err) {
      console.error("Error deleting:", err);
    }
  };

  const calculateDaysLeft = (dateString) => {
    const diff = new Date(dateString) - new Date();
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    return days;
  };

  const sendReminder = (sub, platform) => {
    const days = calculateDaysLeft(sub.expiryDate);
    const message = `تذكير: اشتراك ${sub.name} سينتهي خلال ${days} أيام (تاريخ الانتهاء: ${sub.expiryDate}). يرجى التحقق من الرصيد!`;
    const encodedMsg = encodeURIComponent(message);
    
    if (platform === 'whatsapp') {
      window.open(`https://wa.me/?text=${encodedMsg}`, '_blank');
    } else {
      window.open(`https://t.me/share/url?url=${window.location.href}&text=${encodedMsg}`, '_blank');
    }
  };

  const totalMonthlySpend = subscriptions.reduce((acc, curr) => acc + curr.price, 0);

  if (!user) return (
    <div className="flex h-screen items-center justify-center bg-gray-50">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 text-right" dir="rtl">
      {/* Header */}
      <nav className="bg-white shadow-sm p-4 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Wallet className="text-blue-600" />
            <h1 className="text-xl font-bold text-gray-800">مدير اشتراكاتي</h1>
          </div>
          <div className="bg-blue-50 px-4 py-2 rounded-lg">
            <span className="text-sm text-blue-600 font-medium">إجمالي المصاريف: {totalMonthlySpend.toLocaleString()} د.ع</span>
          </div>
        </div>
      </nav>

      <main className="max-w-4xl mx-auto p-4 space-y-6">
        
        {/* Statistics Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
            <div className="p-3 bg-blue-100 rounded-lg text-blue-600"><TrendingUp size={24}/></div>
            <div>
              <p className="text-sm text-gray-500">الاشتراكات النشطة</p>
              <p className="text-xl font-bold">{subscriptions.length}</p>
            </div>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
            <div className="p-3 bg-red-100 rounded-lg text-red-600"><AlertCircle size={24}/></div>
            <div>
              <p className="text-sm text-gray-500">تحتاج تجديد (قريباً)</p>
              <p className="text-xl font-bold text-red-600">
                {subscriptions.filter(s => calculateDaysLeft(s.expiryDate) < 5).length}
              </p>
            </div>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
            <div className="p-3 bg-green-100 rounded-lg text-green-600"><Clock size={24}/></div>
            <div>
              <p className="text-sm text-gray-500">المعدل الشهري</p>
              <p className="text-xl font-bold">{(totalMonthlySpend / (subscriptions.length || 1)).toFixed(0)} د.ع</p>
            </div>
          </div>
        </div>

        {/* Add New Subscription */}
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
          <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Plus className="text-blue-600" size={20} />
            إضافة اشتراك جديد
          </h2>
          <form onSubmit={addSubscription} className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input 
              type="text" 
              placeholder="اسم الاشتراك (مثل ChatGPT)" 
              className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
            />
            <input 
              type="number" 
              placeholder="السعر (د.ع)" 
              className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
              value={price}
              onChange={(e) => setPrice(e.target.value)}
              required
            />
            <input 
              type="date" 
              className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
              value={expiryDate}
              onChange={(e) => setExpiryDate(e.target.value)}
              required
            />
            <button 
              type="submit" 
              className="bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100"
            >
              حفظ الاشتراك
            </button>
          </form>
        </div>

        {/* Subscriptions List */}
        <div className="space-y-4">
          <h2 className="text-lg font-bold text-gray-700">قائمة اشتراكاتك</h2>
          {loading ? (
             <div className="text-center py-10 text-gray-400">جاري التحميل...</div>
          ) : subscriptions.length === 0 ? (
            <div className="text-center py-20 bg-gray-50 border-2 border-dashed rounded-2xl">
              <p className="text-gray-400">لا توجد اشتراكات مضافة حالياً.</p>
            </div>
          ) : (
            subscriptions.map((sub) => {
              const daysLeft = calculateDaysLeft(sub.expiryDate);
              const isExpired = daysLeft <= 0;
              const isWarning = daysLeft <= 5 && daysLeft > 0;

              return (
                <div key={sub.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 transition hover:shadow-md">
                  <div className="flex items-center gap-4 w-full md:w-auto">
                    <div className={`p-3 rounded-full ${isExpired ? 'bg-red-100 text-red-600' : isWarning ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'}`}>
                      <Calendar size={24} />
                    </div>
                    <div>
                      <h3 className="font-bold text-lg">{sub.name}</h3>
                      <p className="text-sm text-gray-500">{sub.price.toLocaleString()} د.ع / شهر</p>
                    </div>
                  </div>

                  <div className="flex flex-col items-center">
                    <span className={`text-sm font-bold px-3 py-1 rounded-full ${isExpired ? 'bg-red-50 text-red-600' : isWarning ? 'bg-yellow-50 text-yellow-600' : 'bg-blue-50 text-blue-600'}`}>
                      {isExpired ? 'منتهي' : `متبقي ${daysLeft} يوم`}
                    </span>
                    <p className="text-xs text-gray-400 mt-1">ينتهي في: {sub.expiryDate}</p>
                  </div>

                  <div className="flex items-center gap-2 w-full md:w-auto justify-center">
                    <button 
                      onClick={() => sendReminder(sub, 'whatsapp')}
                      className="p-2 text-green-600 hover:bg-green-50 rounded-lg flex items-center gap-1 text-sm font-medium border border-green-100"
                      title="تذكير واتساب"
                    >
                      <MessageCircle size={18} />
                      تذكير واتس
                    </button>
                    <button 
                      onClick={() => sendReminder(sub, 'telegram')}
                      className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg flex items-center gap-1 text-sm font-medium border border-blue-100"
                      title="تذكير تليجرام"
                    >
                      <Send size={18} />
                      تليجرام
                    </button>
                    <button 
                      onClick={() => deleteSubscription(sub.id)}
                      className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </main>

      <footer className="py-10 text-center text-gray-400 text-sm">
        نظام إدارة الاشتراكات والمصاريف الذكي &copy; 2024
      </footer>
    </div>
  );
}

