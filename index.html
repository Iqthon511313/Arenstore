<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ± - Arin Store Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .card-active { border: 2px solid transparent; transition: 0.3s; }
        .card-expired { border: 2px solid #ef4444 !important; background-color: #fef2f2; }
        .card-near { border: 2px solid #f97316 !important; background-color: #fffaf5; }
        .filter-btn-active { background-color: #312e81 !important; color: white !important; }
    </style>
</head>
<body class="pb-20">

    <!-- Header -->
    <header class="bg-indigo-950 text-white p-4 sticky top-0 z-[100] shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-bolt text-yellow-400"></i>
                <h1 class="text-xl font-black">Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ±</h1>
            </div>
            <div id="conn-status" class="text-[10px] bg-red-500/20 text-red-400 px-3 py-1 rounded-full border border-red-500/30">
                ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† (ØºÙŠØ± Ù…ØªØµÙ„)
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-5xl">
        
        <!-- Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-indigo-600">
                <p class="text-gray-400 text-[10px] font-bold">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</p>
                <h2 id="s-total" class="text-xl font-black">0</h2>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-red-600">
                <p class="text-gray-400 text-[10px] font-bold">Ù…Ù†ØªÙ‡ÙŠ</p>
                <h2 id="s-expired" class="text-xl font-black text-red-600">0</h2>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-emerald-500">
                <p class="text-gray-400 text-[10px] font-bold">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</p>
                <h2 id="s-profit" class="text-xl font-black text-emerald-600">$0</h2>
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border-b-4 border-orange-500">
                <p class="text-gray-400 text-[10px] font-bold">Ù‚Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</p>
                <h2 id="s-near" class="text-xl font-black text-orange-600">0</h2>
            </div>
        </div>

        <!-- Filters & Actions -->
        <div class="flex flex-col gap-4 mb-6">
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                <button onclick="setFilter('all')" id="f-all" class="filter-btn-active whitespace-nowrap px-5 py-2 rounded-xl text-xs font-bold bg-white text-gray-500 shadow-sm">Ø§Ù„ÙƒÙ„</button>
                <button onclick="setFilter('active')" id="f-active" class="whitespace-nowrap px-5 py-2 rounded-xl text-xs font-bold bg-white text-gray-500 shadow-sm">Ù†Ø´Ø·</button>
                <button onclick="setFilter('expired')" id="f-expired" class="whitespace-nowrap px-5 py-2 rounded-xl text-xs font-bold bg-white text-gray-500 shadow-sm text-red-500">Ù…Ù†ØªÙ‡ÙŠ ÙÙ‚Ø· âš ï¸</button>
                <button onclick="setFilter('near')" id="f-near" class="whitespace-nowrap px-5 py-2 rounded-xl text-xs font-bold bg-white text-gray-500 shadow-sm text-orange-500">Ù‚Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
            </div>
            
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search" oninput="render()" placeholder="Ø§Ø¨Ø­Ø«..." class="w-full pr-10 pl-4 py-3 rounded-2xl bg-white border-none shadow-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="openModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-black shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <!-- List -->
        <div id="list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/60 z-[200] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div class="p-6 bg-indigo-950 text-white flex justify-between">
                <h2 class="font-black">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</h2>
                <button onclick="closeModal()">&times;</button>
            </div>
            <form id="form" onsubmit="save(event)" class="p-6 space-y-3">
                <input type="hidden" id="edit-id">
                <input id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" required class="w-full p-3 bg-gray-50 border rounded-xl outline-none">
                <div class="grid grid-cols-2 gap-2">
                    <select id="in-service" class="p-3 bg-gray-50 border rounded-xl">
                        <option>ChatGPT</option><option>Netflix</option><option>YouTube</option><option>Canva</option><option>Nitro</option>
                    </select>
                    <select id="in-dur" onchange="autoDate()" class="p-3 bg-gray-50 border rounded-xl">
                        <option value="1">Ø´Ù‡Ø±ÙŠ</option><option value="12">Ø³Ù†ÙˆÙŠ</option><option value="0">Ù…Ø®ØµØµ</option>
                    </select>
                </div>
                <input id="in-email" type="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" required class="w-full p-3 bg-gray-50 border rounded-xl">
                <input id="in-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full p-3 bg-gray-50 border rounded-xl">
                <div class="grid grid-cols-2 gap-2">
                    <input id="in-price" type="number" step="0.1" placeholder="Ø§Ù„Ø³Ø¹Ø± $" required class="p-3 bg-gray-50 border rounded-xl">
                    <input id="in-date" type="date" required class="p-3 bg-gray-50 border rounded-xl">
                </div>
                <select id="in-paid" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <option value="true">ÙˆØ§ØµÙ„ âœ…</option><option value="false">Ù…Ø·Ù„ÙˆØ¨ âŒ</option>
                </select>
                <button type="submit" class="w-full bg-indigo-900 text-white py-4 rounded-2xl font-black">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ÙƒÙŠ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHubØŒ ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§
        let config = {};
        try { config = JSON.parse(__firebase_config); } catch(e) { 
            console.error("Firebase config not found. Please add it manually for GitHub deployment.");
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arin-store-fixed-v1';
        let db, auth;
        let items = [];
        let currentFilter = 'all';

        // Initialize UI immediately
        window.openModal = (data = null) => {
            document.getElementById('form').reset();
            document.getElementById('edit-id').value = data ? data.id : '';
            if(data) {
                document.getElementById('in-name').value = data.name;
                document.getElementById('in-service').value = data.service;
                document.getElementById('in-email').value = data.email;
                document.getElementById('in-phone').value = data.phone || '';
                document.getElementById('in-price').value = data.price;
                document.getElementById('in-date').value = data.date;
                document.getElementById('in-paid').value = data.paid.toString();
            } else {
                autoDate();
            }
            document.getElementById('modal').classList.replace('hidden', 'flex');
        };

        window.closeModal = () => document.getElementById('modal').classList.replace('flex', 'hidden');

        window.autoDate = () => {
            const m = parseInt(document.getElementById('in-dur').value);
            if(m > 0) {
                const d = new Date();
                d.setMonth(d.getMonth() + m);
                document.getElementById('in-date').value = d.toISOString().split('T')[0];
            }
        };

        window.setFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('[id^="f-"]').forEach(btn => btn.classList.remove('filter-btn-active'));
            document.getElementById('f-' + f).classList.add('filter-btn-active');
            render();
        };

        // Firebase Sync
        async function connect() {
            if(!config.apiKey) return;
            const app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);
            
            await signInAnonymously(auth);
            document.getElementById('conn-status').innerText = "Ù…ØªØµÙ„ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ âœ…";
            document.getElementById('conn-status').className = "text-[10px] bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/30";

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'subs'), (s) => {
                items = s.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
        }

        window.save = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                name: document.getElementById('in-name').value,
                service: document.getElementById('in-service').value,
                email: document.getElementById('in-email').value,
                phone: document.getElementById('in-phone').value,
                price: parseFloat(document.getElementById('in-price').value),
                date: document.getElementById('in-date').value,
                paid: document.getElementById('in-paid').value === 'true',
                ts: Date.now()
            };
            if(db) {
                const col = collection(db, 'artifacts', appId, 'public', 'data', 'subs');
                id ? await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subs', id), data) : await addDoc(col, data);
            }
            closeModal();
        };

        window.del = async (id) => {
            if(confirm('Ø­Ø°ÙØŸ') && db) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subs', id));
        };

        window.remind = (id) => {
            const s = items.find(x => x.id === id);
            const msg = `ØªØ°ÙƒÙŠØ± Ù…Ù† Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ± ğŸ‘‘: Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ ${s.service} Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.`;
            const url = s.phone ? `https://wa.me/${s.phone.replace('+','')}` : `https://t.me/share/url?url=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        };

        window.render = () => {
            const q = document.getElementById('search').value.toLowerCase();
            const list = document.getElementById('list');
            const now = new Date();

            let filtered = items.filter(i => i.name.toLowerCase().includes(q) || i.service.toLowerCase().includes(q));

            if(currentFilter === 'expired') {
                filtered = filtered.filter(i => new Date(i.date) <= now);
            } else if(currentFilter === 'near') {
                filtered = filtered.filter(i => {
                    const diff = Math.ceil((new Date(i.date) - now) / 86400000);
                    return diff > 0 && diff <= 3;
                });
            } else if(currentFilter === 'active') {
                filtered = filtered.filter(i => new Date(i.date) > now);
            }

            list.innerHTML = filtered.map(i => {
                const diff = Math.ceil((new Date(i.date) - now) / 86400000);
                const isExp = diff <= 0;
                const isNear = diff > 0 && diff <= 3;
                
                return `
                <div class="bg-white p-5 rounded-[2rem] shadow-sm card-active ${isExp ? 'card-expired' : (isNear ? 'card-near' : '')}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-black text-slate-800">${i.name}</h3>
                            <p class="text-[10px] text-indigo-600 font-bold">${i.service}</p>
                        </div>
                        <div class="text-left">
                            <p class="font-black text-slate-900">$${i.price}</p>
                            <span class="text-[9px] font-bold ${i.paid ? 'text-emerald-500' : 'text-red-500 animate-pulse'}">${i.paid ? 'ÙˆØ§ØµÙ„' : 'Ù…Ø·Ù„ÙˆØ¨'}</span>
                        </div>
                    </div>
                    <div class="text-[9px] text-gray-400 mb-4 truncate">${i.email}</div>
                    <div class="flex justify-between items-center text-xs bg-gray-50 p-2 rounded-xl mb-4">
                        <span class="text-gray-400">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                        <span class="font-black ${isExp ? 'text-red-600' : 'text-slate-700'}">${isExp ? 'Ù…Ù†ØªÙ‡ÙŠ âš ï¸' : diff + ' ÙŠÙˆÙ…'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="remind('${i.id}')" class="flex-1 bg-indigo-950 text-white py-2 rounded-lg text-[10px] font-bold">ØªØ°ÙƒÙŠØ±</button>
                        <button onclick='openModal(${JSON.stringify(i)})' class="p-2 bg-gray-100 text-gray-400 rounded-lg"><i class="fas fa-edit"></i></button>
                        <button onclick="del('${i.id}')" class="p-2 bg-gray-100 text-gray-200 rounded-lg hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');

            // Stats
            document.getElementById('s-total').innerText = items.length;
            document.getElementById('s-expired').innerText = items.filter(i => new Date(i.date) <= now).length;
            document.getElementById('s-near').innerText = items.filter(i => {
                const d = Math.ceil((new Date(i.date) - now) / 86400000);
                return d > 0 && d <= 3;
            }).length;
            const rev = items.filter(i => i.paid).reduce((a,b) => a + b.price, 0);
            document.getElementById('s-profit').innerText = '$' + rev.toFixed(1);
        };

        connect();
    </script>
</body>
</html>

