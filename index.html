<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุขุฑูู ุณุชูุฑ - Arin Store Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .card-anim { transition: all 0.3s ease; }
        .card-anim:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="pb-10">

    <div id="loader" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-900 mb-4"></div>
        <p class="text-indigo-900 font-bold">ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุณุญุงุจุฉ...</p>
    </div>

    <header class="bg-indigo-900 text-white sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-store text-2xl"></i>
                <h1 class="text-xl font-black">ุขุฑูู ุณุชูุฑ</h1>
            </div>
            <div class="flex bg-indigo-800 p-1 rounded-2xl">
                <button onclick="switchTab('subs')" id="btn-subs" class="px-6 py-2 rounded-xl font-bold bg-white text-indigo-900 shadow-sm transition-all">ุงูุงุดุชุฑุงูุงุช</button>
                <button onclick="switchTab('exps')" id="btn-exps" class="px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition-all">ุงูุตุฑููุงุช</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-6xl">
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 my-6">
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border-r-4 border-blue-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">ุงููุดุทูู</p>
                <h3 id="stat-active" class="text-2xl font-black text-slate-800">0</h3>
            </div>
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border-r-4 border-orange-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">ูุฑุจ ููุชูู</p>
                <h3 id="stat-soon" class="text-2xl font-black text-slate-800">0</h3>
            </div>
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border-r-4 border-emerald-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">ุตุงูู ุงูุฑุจุญ</p>
                <h3 id="stat-profit" class="text-2xl font-black text-emerald-600">$0</h3>
            </div>
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border-r-4 border-red-500">
                <p class="text-gray-400 text-[10px] font-bold uppercase mb-1">ุฅุฌูุงูู ุงูุตุฑู</p>
                <h3 id="stat-exps" class="text-2xl font-black text-red-600">$0</h3>
            </div>
        </div>

        <!-- Subs View -->
        <div id="view-subs">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="setFilter('all')" class="filter-btn px-6 py-2 rounded-full bg-indigo-900 text-white text-xs font-bold" data-f="all">ุงููู</button>
                    <button onclick="setFilter('active')" class="filter-btn px-6 py-2 rounded-full bg-white text-gray-500 text-xs font-bold border" data-f="active">ุงููุดุทูู</button>
                    <button onclick="setFilter('soon')" class="filter-btn px-6 py-2 rounded-full bg-white text-gray-500 text-xs font-bold border" data-f="soon">ูุฑุจ ููุชูู</button>
                    <button onclick="setFilter('unpaid')" class="filter-btn px-6 py-2 rounded-full bg-white text-gray-500 text-xs font-bold border" data-f="unpaid">ุบูุฑ ูุณุฏุฏ</button>
                </div>
                <button onclick="openSubModal()" class="bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black shadow-lg hover:bg-indigo-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุดุชุฑู
                </button>
            </div>

            <div class="relative mb-8">
                <i class="fas fa-search absolute right-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" oninput="render()" placeholder="ุงุจุญุซ ุจุงุณู ุงูุฒุจูู ุฃู ุงูุญุณุงุจ..." class="w-full pr-14 pl-6 py-4 rounded-[1.5rem] bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>

            <div id="subs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Expenses View -->
        <div id="view-exps" class="hidden">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black">ุณุฌู ุงูุตุฑููุงุช</h2>
                    <button onclick="openExpModal()" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold">ุฅุถุงูุฉ ุตุฑููุฉ</button>
                </div>
                <div id="exps-list"></div>
            </div>
        </div>
    </main>

    <!-- Sub Modal -->
    <div id="subModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div class="bg-indigo-900 p-6 text-white flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-black">ุฅุถุงูุฉ ูุดุชุฑู</h2>
                <button onclick="closeModal('subModal')"><i class="fas fa-times"></i></button>
            </div>
            <form id="subForm" onsubmit="handleSubSubmit(event)" class="p-8 space-y-4 max-h-[80vh] overflow-y-auto custom-scroll">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุงุณู ุงูุฒุจูู</label>
                        <input id="in-name" required class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุฅูููู ุงูุญุณุงุจ</label>
                        <input id="in-email" type="email" required class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุงูุฎุฏูุฉ</label>
                        <select id="in-service" class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                            <option>ChatGPT</option><option>Netflix</option><option>YouTube Premium</option><option>Canva Pro</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุงูุฎุทุฉ</label>
                        <select id="in-plan" onchange="toggleDate()" class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                            <option value="monthly">ุดูุฑู</option><option value="yearly">ุณููู</option><option value="custom">ูุฎุตุตุฉ</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุงูุชูุฌุฑุงู ุฃู ุงูุฑูู (ุณูุถุงู +964)</label>
                        <input id="in-contact" required placeholder="ูุซุงู: 7701234567" class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุงูุณุนุฑ ($)</label>
                        <input id="in-price" type="number" step="0.01" required class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="text-[10px] font-bold text-gray-400 mr-2">ุญุงูุฉ ุงูุฏูุน</label>
                        <select id="in-paid" class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                            <option value="true">ูุงุตู โ</option><option value="false">ูุทููุจ โ</option>
                        </select>
                    </div>
                    <div id="customDate" class="col-span-2 hidden">
                        <label class="text-[10px] font-bold text-indigo-600 mr-2">ุชุงุฑูุฎ ุงูุงูุชูุงุก</label>
                        <input id="in-expiry" type="date" class="w-full p-3 bg-indigo-50 rounded-xl outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-900 text-white py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-black">ุญูุธ ุณุญุงุจู</button>
            </form>
        </div>
    </div>

    <!-- Exp Modal -->
    <div id="expModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden">
            <div class="bg-red-600 p-6 text-white flex justify-between items-center">
                <h2 class="text-xl font-black">ุฅุถุงูุฉ ุตุฑููุฉ</h2>
                <button onclick="closeModal('expModal')"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="handleExpSubmit(event)" class="p-8 space-y-4">
                <input id="ex-title" placeholder="ุจูุงู ุงูุตุฑู" required class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                <input id="ex-amount" type="number" step="0.01" placeholder="ุงููุจูุบ ($)" required class="w-full p-3 bg-gray-50 rounded-xl ring-1 ring-gray-200 outline-none">
                <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black shadow-lg">ุชุณุฌูู</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arin-store-cloud';

        let subscriptions = [];
        let expenses = [];
        let currentFilter = 'all';

        // Auth Setup
        async function init() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    setupListeners();
                    document.getElementById('loader').classList.add('hidden');
                }
            });
        }

        function setupListeners() {
            const subsRef = collection(db, 'artifacts', appId, 'public', 'data', 'subscriptions');
            const expsRef = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');

            onSnapshot(subsRef, (snap) => {
                subscriptions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (err) => console.error(err));

            onSnapshot(expsRef, (snap) => {
                expenses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (err) => console.error(err));
        }

        // Exposed Functions
        window.switchTab = (tab) => {
            document.getElementById('view-subs').classList.toggle('hidden', tab !== 'subs');
            document.getElementById('view-exps').classList.toggle('hidden', tab !== 'exps');
            document.getElementById('btn-subs').className = tab === 'subs' ? 'px-6 py-2 rounded-xl font-bold bg-white text-indigo-900 shadow-sm transition-all' : 'px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition-all';
            document.getElementById('btn-exps').className = tab === 'exps' ? 'px-6 py-2 rounded-xl font-bold bg-white text-indigo-900 shadow-sm transition-all' : 'px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition-all';
        };

        window.openSubModal = (editData = null) => {
            const form = document.getElementById('subForm');
            form.reset();
            document.getElementById('editId').value = editData ? editData.id : '';
            document.getElementById('modalTitle').innerText = editData ? 'ุชุนุฏูู ุงููุดุชุฑู' : 'ุฅุถุงูุฉ ูุดุชุฑู';
            
            if (editData) {
                document.getElementById('in-name').value = editData.name;
                document.getElementById('in-email').value = editData.email;
                document.getElementById('in-service').value = editData.service;
                document.getElementById('in-plan').value = editData.plan;
                document.getElementById('in-contact').value = editData.contact;
                document.getElementById('in-price').value = editData.price;
                document.getElementById('in-paid').value = editData.isPaid.toString();
                if (editData.plan === 'custom') {
                    document.getElementById('customDate').classList.remove('hidden');
                    document.getElementById('in-expiry').value = editData.expiry;
                }
            }
            
            document.getElementById('subModal').classList.remove('hidden');
            document.getElementById('subModal').classList.add('flex');
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        };

        window.toggleDate = () => {
            const plan = document.getElementById('in-plan').value;
            document.getElementById('customDate').classList.toggle('hidden', plan !== 'custom');
        };

        window.handleSubSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const plan = document.getElementById('in-plan').value;
            let expiry = document.getElementById('in-expiry').value;

            if (plan !== 'custom') {
                const date = new Date();
                plan === 'monthly' ? date.setMonth(date.getMonth() + 1) : date.setFullYear(date.getFullYear() + 1);
                expiry = date.toISOString().split('T')[0];
            }

            let contact = document.getElementById('in-contact').value.trim();
            if (/^\d+$/.test(contact)) {
                if (contact.startsWith('0')) contact = contact.substring(1);
                if (!contact.startsWith('964')) contact = '964' + contact;
                contact = '+' + contact;
            }

            const data = {
                name: document.getElementById('in-name').value,
                email: document.getElementById('in-email').value,
                service: document.getElementById('in-service').value,
                plan: plan,
                contact: contact,
                price: parseFloat(document.getElementById('in-price').value),
                isPaid: document.getElementById('in-paid').value === 'true',
                expiry: expiry,
                updatedAt: new Date().toISOString()
            };

            if (id) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subscriptions', id), data);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subscriptions'), data);
            }
            window.closeModal('subModal');
        };

        window.handleExpSubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                title: document.getElementById('ex-title').value,
                amount: parseFloat(document.getElementById('ex-amount').value),
                date: new Date().toISOString()
            });
            window.closeModal('expModal');
        };

        window.deleteItem = async (type, id) => {
            if (confirm('ุญุฐู ููุงุฆูุ')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type === 'sub' ? 'subscriptions' : 'expenses', id));
            }
        };

        window.setFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.f === f;
                btn.className = `filter-btn px-6 py-2 rounded-full text-xs font-bold transition-all ${isActive ? 'bg-indigo-900 text-white' : 'bg-white text-gray-500 border border-gray-100'}`;
            });
            render();
        };

        window.openExpModal = () => {
            document.getElementById('expModal').classList.remove('hidden');
            document.getElementById('expModal').classList.add('flex');
        };

        window.formatWhatsApp = (id) => {
            const s = subscriptions.find(x => x.id === id);
            const today = new Date();
            const expDate = new Date(s.expiry);
            const diff = Math.ceil((expDate - today) / (1000 * 3600 * 24));
            
            const msg = `*ุขุฑูู ุณุชูุฑ - ุชุฐููุฑ* ๐\n\nุนุฒูุฒู *${s.name}*\nุงุดุชุฑุงูู ูู *${s.service}* ุฃูุดู ุนูู ุงูุงูุชูุงุก.\n\n๐ ููุชูู ููู: ${expDate.toLocaleDateString('ar-EG')}\nโณ ุงููุชุจูู: ${diff > 0 ? diff + ' ููู' : 'ููุชูู'}\n๐ฐ ุงููุทููุจ: $${s.price.toFixed(2)}\n\nูุฑุฌู ุงูุชูุงุตู ููุชุฌุฏูุฏ โจ`;
            
            const link = s.contact.startsWith('+') 
                ? `https://wa.me/${s.contact.replace('+', '')}?text=${encodeURIComponent(msg)}`
                : `https://t.me/${s.contact.replace('@', '')}`;
            window.open(link, '_blank');
        };

        window.render = () => {
            const grid = document.getElementById('subs-grid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const today = new Date();

            const filtered = subscriptions.filter(s => {
                const match = s.name.toLowerCase().includes(search) || s.email.toLowerCase().includes(search);
                const expDate = new Date(s.expiry);
                const diff = (expDate - today) / (1000 * 3600 * 24);
                if (currentFilter === 'active') return match && expDate > today;
                if (currentFilter === 'soon') return match && diff <= 3 && diff > 0;
                if (currentFilter === 'unpaid') return match && !s.isPaid;
                return match;
            });

            grid.innerHTML = filtered.map(s => {
                const expDate = new Date(s.expiry);
                const diff = Math.ceil((expDate - today) / (1000 * 3600 * 24));
                const isExpired = diff <= 0;
                
                return `
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-50 card-anim relative overflow-hidden">
                    ${diff <= 3 && diff > 0 ? '<div class="absolute top-0 right-0 bg-orange-500 text-white text-[10px] px-4 py-1 rounded-bl-2xl font-black">ูุฑุจ ููุชูู</div>' : ''}
                    ${isExpired ? '<div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] px-4 py-1 rounded-bl-2xl font-black">ููุชูู</div>' : ''}
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-3">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-900 rounded-xl flex items-center justify-center font-black text-xl">${s.name[0]}</div>
                            <div>
                                <h4 class="font-bold text-slate-800">${s.name}</h4>
                                <p class="text-[10px] text-gray-400 font-bold tracking-wider">${s.service}</p>
                            </div>
                        </div>
                        <div class="text-left">
                            <div class="text-lg font-black text-slate-900">$${s.price.toFixed(2)}</div>
                            <span class="text-[9px] px-2 py-0.5 rounded-full font-bold ${s.isPaid ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-600 animate-pulse'}">${s.isPaid ? 'ูุงุตู' : 'ูุทููุจ'}</span>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl mb-4 flex justify-between items-center text-xs">
                        <span class="text-gray-400">ุงููุชุจูู:</span>
                        <span class="font-black ${isExpired ? 'text-red-600' : 'text-indigo-700'}">${isExpired ? 'ููุชูู' : diff + ' ููู'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="formatWhatsApp('${s.id}')" class="flex-1 bg-indigo-900 text-white py-3 rounded-xl text-xs font-bold hover:bg-black transition-all">ุชุฐููุฑ</button>
                        <button onclick="openSubModal(${JSON.stringify(s).replace(/"/g, '&quot;')})" class="p-3 bg-slate-100 text-slate-500 rounded-xl hover:text-indigo-600"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteItem('sub', '${s.id}')" class="p-3 bg-slate-100 text-slate-300 rounded-xl hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`;
            }).join('');

            // Stats
            const totalRev = subscriptions.filter(s => s.isPaid).reduce((a, b) => a + b.price, 0);
            const totalExp = expenses.reduce((a, b) => a + b.amount, 0);
            document.getElementById('stat-active').innerText = subscriptions.filter(s => new Date(s.expiry) > today).length;
            document.getElementById('stat-soon').innerText = subscriptions.filter(s => { const d = (new Date(s.expiry) - today) / 86400000; return d > 0 && d <= 3; }).length;
            document.getElementById('stat-profit').innerText = `$${(totalRev - totalExp).toFixed(2)}`;
            document.getElementById('stat-exps').innerText = `$${totalExp.toFixed(2)}`;

            // Expenses table
            document.getElementById('exps-list').innerHTML = `
            <table class="w-full text-right text-sm">
                <tr class="text-gray-400 border-b"><th class="pb-3 px-2">ุงูุจูุงู</th><th class="pb-3 text-center">ุงููุจูุบ</th><th class="pb-3 text-center">ุญุฐู</th></tr>
                ${expenses.map(e => `
                <tr class="border-b border-gray-50">
                    <td class="py-4 px-2 font-bold">${e.title}<br><span class="text-[10px] text-gray-300 font-normal">${new Date(e.date).toLocaleDateString('ar-EG')}</span></td>
                    <td class="text-center font-black text-red-500">$${e.amount.toFixed(2)}</td>
                    <td class="text-center"><button onclick="deleteItem('exp', '${e.id}')" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('')}
            </table>`;
        };

        init();
    </script>
</body>
</html>

