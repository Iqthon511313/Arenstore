<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø£Ø±ÙŠÙ† Ø³ØªÙˆØ± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;800;900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #050608; color: #f8fafc; }
        .glass-nav { background: rgba(10, 15, 25, 0.95); backdrop-filter: blur(15px); }
        .active-scale:active { transform: scale(0.96); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKok61chnRv9_-QQeQ-TP9WkZwc8cqqac",
            authDomain: "arenstore-d61ce.firebaseapp.com",
            projectId: "arenstore-d61ce",
            storageBucket: "arenstore-d61ce.firebasestorage.app",
            messagingSenderId: "5224012268",
            appId: "1:5224012268:web:11d11411b57247a87f08c9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "aren_store_v5_fix";

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [subscriptions, setSubscriptions] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('subs');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterUrgent, setFilterUrgent] = useState(false);

            const [form, setForm] = useState({
                name: '', email: '', contact: '', socialLink: '', 
                service: 'ChatGPT Plus', price: '', plan: 'monthly', customDays: ''
            });
            const [expForm, setExpForm] = useState({ title: '', amount: '' });

            useEffect(() => {
                signInAnonymously(auth).then(() => {
                    const unsubSubs = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'subs'), (s) => {
                        setSubscriptions(s.docs.map(d => ({ id: d.id, ...d.data() })));
                        setLoading(false);
                    }, () => setLoading(false));

                    const unsubExp = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'expenses'), (s) => {
                        setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    });

                    return () => { unsubSubs(); unsubExp(); };
                });
            }, []);

            const daysLeft = (date) => {
                if (!date) return 0;
                const diff = new Date(date) - new Date();
                return Math.ceil(diff / (1000 * 60 * 60 * 24));
            };

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø£Ù…Ø§Ù† ØªØ§Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡
            const stats = useMemo(() => {
                try {
                    const activeList = (subscriptions || []).filter(s => daysLeft(s.expiryDate) > 0);
                    const totalRev = (subscriptions || []).reduce((a, b) => a + (Number(b.price) || 0), 0);
                    const totalExp = (expenses || []).reduce((a, b) => a + (Number(b.amount) || 0), 0);
                    
                    return {
                        net: totalRev - totalExp,
                        active: activeList.length,
                        monthly: activeList.filter(s => s.plan === 'monthly').length,
                        threeMonths: activeList.filter(s => s.plan === '3months').length,
                        yearly: activeList.filter(s => s.plan === 'yearly').length,
                        totalRev,
                        totalExp
                    };
                } catch (e) {
                    return { net:0, active:0, monthly:0, threeMonths:0, yearly:0, totalRev:0, totalExp:0 };
                }
            }, [subscriptions, expenses]);

            const filteredList = useMemo(() => {
                const search = searchTerm.toLowerCase();
                return (subscriptions || []).filter(s => {
                    const matches = 
                        (s.name || '').toLowerCase().includes(search) || 
                        (s.email || '').toLowerCase().includes(search) || 
                        (s.contact || '').toLowerCase().includes(search) || 
                        (s.service || '').toLowerCase().includes(search);
                    
                    if (filterUrgent) return matches && daysLeft(s.expiryDate) <= 5;
                    return matches;
                });
            }, [subscriptions, searchTerm, filterUrgent]);

            const handleSave = async (e) => {
                e.preventDefault();
                let expiry = new Date();
                if(form.plan === 'monthly') expiry.setMonth(expiry.getMonth() + 1);
                else if(form.plan === '3months') expiry.setMonth(expiry.getMonth() + 3);
                else if(form.plan === 'yearly') expiry.setFullYear(expiry.getFullYear() + 1);
                else expiry.setDate(expiry.getDate() + (parseInt(form.customDays) || 0));

                const data = { ...form, expiryDate: expiry.toISOString().split('T')[0] };
                try {
                    if (editingItem) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'subs', editingItem.id), data);
                    else await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'subs'), { ...data, createdAt: Date.now() });
                    setIsModalOpen(false);
                } catch (err) { console.error(err); }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-black text-[#D4AF37] font-black uppercase tracking-widest">Loading...</div>;

            return (
                <div className="min-h-screen pb-24">
                    <header className="p-4 flex justify-between items-center sticky top-0 glass-nav z-40 border-b border-white/5">
                        <h1 className="text-xl font-black italic">AREN <span className="text-[#D4AF37]">STORE</span></h1>
                        <div className="flex gap-2">
                            <button onClick={() => setIsExpenseModalOpen(true)} className="p-2 bg-rose-500/10 text-rose-500 rounded-lg"><Icon name="minus" /></button>
                            <button onClick={() => { setEditingItem(null); setIsModalOpen(true); }} className="bg-[#D4AF37] text-black px-4 py-2 rounded-lg font-black text-xs">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ</button>
                        </div>
                    </header>

                    <main className="p-4 max-w-2xl mx-auto">
                        {activeTab === 'dashboard' ? (
                            <div className="space-y-4">
                                <div className="bg-[#0D1117] p-6 rounded-3xl border border-[#D4AF37]/30 shadow-xl">
                                    <p className="text-[#D4AF37] text-[10px] font-black mb-1 uppercase">ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p>
                                    <h2 className="text-4xl font-black tracking-tighter">${stats.net}</h2>
                                    <div className="grid grid-cols-2 gap-2 mt-4">
                                        <div className="bg-white/5 p-3 rounded-xl"><p className="text-[8px] text-slate-500">Ù…Ø¨ÙŠØ¹Ø§Øª</p><p className="font-black text-emerald-400">${stats.totalRev}</p></div>
                                        <div className="bg-white/5 p-3 rounded-xl"><p className="text-[8px] text-slate-500">Ù…ØµØ§Ø±ÙŠÙ</p><p className="font-black text-rose-400">${stats.totalExp}</p></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                                        <p className="text-2xl font-black">{stats.active}</p>
                                        <p className="text-[9px] text-slate-500 font-bold">Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                                        <p className="text-2xl font-black">{stats.monthly}</p>
                                        <p className="text-[9px] text-slate-500 font-bold">Ø´Ù‡Ø±ÙŠ</p>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                                        <p className="text-2xl font-black">{stats.threeMonths}</p>
                                        <p className="text-[9px] text-slate-500 font-bold">3 Ø£Ø´Ù‡Ø±</p>
                                    </div>
                                    <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                                        <p className="text-2xl font-black">{stats.yearly}</p>
                                        <p className="text-[9px] text-slate-500 font-bold">Ø³Ù†ÙˆÙŠ</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø£ÙŠ Ø´ÙŠØ¡ (Ø§Ø³Ù…ØŒ Ø¥ÙŠÙ…ÙŠÙ„ØŒ ÙŠÙˆØ²Ø±ØŒ Ø®Ø¯Ù…Ø©)..." className="w-full bg-[#0D1117] border border-white/10 p-4 rounded-xl text-sm font-bold" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                <button onClick={() => setFilterUrgent(!filterUrgent)} className={`w-full p-3 rounded-xl text-[10px] font-black border transition-colors ${filterUrgent ? 'bg-rose-500 text-white' : 'bg-white/5 text-slate-500 border-white/5'}`}>ÙÙ„ØªØ±Ø©: Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ 5 Ø£ÙŠØ§Ù… Ø£Ùˆ Ø£Ù‚Ù„</button>
                                <div className="space-y-3">
                                    {filteredList.map(s => {
                                        const left = daysLeft(s.expiryDate);
                                        return (
                                            <div key={s.id} className="bg-[#0D1117] p-5 rounded-2xl border border-white/5">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h3 className="font-black text-white">{s.name}</h3>
                                                        <p className="text-[10px] text-[#D4AF37] font-bold">{s.service} â€¢ ${s.price}</p>
                                                    </div>
                                                    <span className={`text-[9px] font-black px-2 py-1 rounded ${left <= 5 ? 'bg-rose-500/20 text-rose-500' : 'bg-blue-500/20 text-blue-400'}`}>{left <= 0 ? 'Ù…Ù†ØªÙ‡ÙŠ' : `${left} ÙŠÙˆÙ…`}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-400 space-y-1 mb-4 bg-black/20 p-3 rounded-xl">
                                                    {s.email && <p>ğŸ“§ {s.email}</p>}
                                                    {s.contact && <p>ğŸ“± {s.contact}</p>}
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => {
                                                        const clean = s.contact?.replace('@','');
                                                        const msg = `ØªØ°ÙƒÙŠØ± ØªØ¬Ø¯ÙŠØ¯ ${s.service}. ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ ${s.expiryDate}`;
                                                        if(/^\d+$/.test(clean)) window.open(`https://wa.me/${clean}?text=${msg}`); else window.open(`https://t.me/${clean}`);
                                                    }} className="flex-1 bg-[#D4AF37]/10 text-[#D4AF37] py-2 rounded-lg font-black text-[10px]">ØªØ°ÙƒÙŠØ±</button>
                                                    <button onClick={() => { setForm(s); setEditingItem(s); setIsModalOpen(true); }} className="p-2 bg-white/5 rounded-lg text-slate-400"><Icon name="edit" size={14}/></button>
                                                    <button onClick={() => deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'subs', s.id))} className="p-2 bg-rose-500/10 rounded-lg text-rose-500"><Icon name="trash" size={14}/></button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 glass-nav border-t border-white/5 flex justify-around p-4 safe-bottom z-50">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 ${activeTab === 'dashboard' ? 'text-[#D4AF37]' : 'text-slate-600'}`}>
                            <Icon name="bar-chart" />
                            <span className="text-[10px] font-black uppercase">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                        </button>
                        <button onClick={() => setActiveTab('subs')} className={`flex flex-col items-center gap-1 ${activeTab === 'subs' ? 'text-[#D4AF37]' : 'text-slate-600'}`}>
                            <Icon name="users" />
                            <span className="text-[10px] font-black uppercase">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</span>
                        </button>
                    </nav>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/95 z-[100] flex flex-col justify-end">
                            <div className="bg-[#0D1117] rounded-t-[2.5rem] p-6 space-y-4">
                                <h2 className="text-center font-black text-[#D4AF37]">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ</h2>
                                <form onSubmit={handleSave} className="space-y-3 pb-8 max-h-[70vh] overflow-y-auto px-1">
                                    <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø§Ù„Ø§Ø³Ù…" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required />
                                    <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" type="email" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="ÙŠÙˆØ²Ø±/Ù‡Ø§ØªÙ" value={form.contact} onChange={e=>setForm({...form, contact:e.target.value})} />
                                        <input className="bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø³ÙˆØ´ÙŠØ§Ù„" value={form.socialLink} onChange={e=>setForm({...form, socialLink:e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø§Ù„Ø³Ø¹Ø± $" type="number" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} required />
                                        <select className="bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" value={form.plan} onChange={e=>setForm({...form, plan:e.target.value})}>
                                            <option value="monthly">Ø´Ù‡Ø±</option>
                                            <option value="3months">3 Ø£Ø´Ù‡Ø±</option>
                                            <option value="yearly">Ø³Ù†Ø©</option>
                                            <option value="custom">Ù…Ø®ØµØµ</option>
                                        </select>
                                    </div>
                                    <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø§Ù„Ø®Ø¯Ù…Ø©" value={form.service} onChange={e=>setForm({...form, service:e.target.value})} required />
                                    <button className="w-full bg-[#D4AF37] text-black py-4 rounded-xl font-black">Ø­ÙØ¸</button>
                                    <button type="button" onClick={()=>setIsModalOpen(false)} className="w-full text-slate-600 text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {isExpenseModalOpen && (
                        <div className="fixed inset-0 bg-black/95 z-[100] flex flex-col justify-center p-6">
                            <div className="bg-[#0D1117] rounded-3xl p-6 border border-rose-500/20 space-y-4">
                                <h2 className="text-center font-black text-rose-500 uppercase">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h2>
                                <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†" value={expForm.title} onChange={e=>setExpForm({...expForm, title:e.target.value})} />
                                <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white text-sm" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" type="number" value={expForm.amount} onChange={e=>setExpForm({...expForm, amount:e.target.value})} />
                                <button onClick={async()=>{await addDoc(collection(db,'artifacts',APP_ID,'public','data','expenses'),{...expForm,date:new Date().toISOString()}); setIsExpenseModalOpen(false);}} className="w-full bg-rose-500 text-white py-4 rounded-xl font-black">Ø®ØµÙ…</button>
                                <button onClick={()=>setIsExpenseModalOpen(false)} className="w-full text-slate-500 text-xs">Ø±Ø¬ÙˆØ¹</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

