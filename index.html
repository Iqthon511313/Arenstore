<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ± - Arin Store Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f0f2f5; }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .tab-active { border-bottom: 3px solid white; opacity: 1; }
        .status-badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 999px; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app">
        <!-- Header -->
        <header class="bg-indigo-800 text-white shadow-xl sticky top-0 z-50">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-white text-indigo-800 p-2 rounded-lg shadow-inner">
                        <i class="fas fa-bolt text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black leading-tight">Ø¢Ø±ÙŠÙ† Ø³ØªÙˆØ±</h1>
                        <p class="text-[10px] text-indigo-200 uppercase tracking-widest font-bold">Arin Store Cloud</p>
                    </div>
                </div>
                <nav class="flex gap-4">
                    <button onclick="switchTab('subs')" id="btn-subs" class="pb-1 font-bold opacity-70 transition-all tab-active">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button>
                    <button onclick="switchTab('exps')" id="btn-exps" class="pb-1 font-bold opacity-70 transition-all">Ø§Ù„ØµØ±ÙÙŠØ§Øª</button>
                </nav>
            </div>
        </header>

        <main class="container mx-auto p-4 max-w-5xl">
            <!-- Numerical Counters (Dynamic Stats) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                <div class="stat-card bg-white p-4 rounded-2xl shadow-sm border-b-4 border-indigo-500 text-center">
                    <p class="text-gray-400 text-xs font-bold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</p>
                    <h3 class="text-2xl font-black text-indigo-700" id="count-active">0</h3>
                </div>
                <div class="stat-card bg-white p-4 rounded-2xl shadow-sm border-b-4 border-orange-400 text-center">
                    <p class="text-gray-400 text-xs font-bold mb-1">Ù‚Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</p>
                    <h3 class="text-2xl font-black text-orange-600" id="count-soon">0</h3>
                </div>
                <div class="stat-card bg-white p-4 rounded-2xl shadow-sm border-b-4 border-emerald-500 text-center">
                    <p class="text-gray-400 text-xs font-bold mb-1">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</p>
                    <h3 class="text-2xl font-black text-emerald-600" id="stat-profit">$0</h3>
                </div>
                <div class="stat-card bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-400 text-center">
                    <p class="text-gray-400 text-xs font-bold mb-1">ØªØ¬Ø±ÙŠØ¨ÙŠ</p>
                    <h3 class="text-2xl font-black text-blue-600" id="count-trial">0</h3>
                </div>
            </div>

            <!-- Subscriptions Dashboard -->
            <div id="subs-section">
                <!-- Advanced Filters -->
                <div class="bg-white p-4 rounded-3xl shadow-sm mb-6 flex flex-wrap gap-2 items-center">
                    <span class="text-gray-400 text-xs font-bold ml-2">ØªØµÙÙŠØ© Ø­Ø³Ø¨:</span>
                    <button onclick="setFilter('all')" class="filter-btn active bg-indigo-600 text-white px-4 py-1.5 rounded-full text-xs font-bold" data-filter="all">Ø§Ù„ÙƒÙ„</button>
                    <button onclick="setFilter('active')" class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold" data-filter="active">Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·</button>
                    <button onclick="setFilter('soon')" class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold" data-filter="soon">Ø£ÙˆØ´Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
                    <button onclick="setFilter('unpaid')" class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold" data-filter="unpaid">ØºÙŠØ± Ù…Ø³Ø¯Ø¯ âŒ</button>
                    <button onclick="setFilter('trial')" class="filter-btn bg-gray-100 text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold" data-filter="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ ğŸ§ª</button>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search" oninput="renderSubs()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." class="w-full pr-12 pl-4 py-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <button onclick="toggleModal('subModal', true)" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-2">
                        <i class="fas fa-user-plus"></i> Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>

                <!-- Subscriptions Grid -->
                <div id="subs-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cards will be injected here -->
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="exps-section" class="hidden">
                <div class="bg-white p-6 rounded-3xl shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black text-gray-800">Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
                        <button onclick="toggleModal('expModal', true)" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-600">Ø¥Ø¶Ø§ÙØ© ØµØ±ÙÙŠØ©</button>
                    </div>
                    <div id="exps-list" class="overflow-x-auto"></div>
                </div>
            </div>
        </main>

        <!-- Sub Modal -->
        <div id="subModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm">
            <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden">
                <div class="bg-indigo-800 p-6 text-white flex justify-between">
                    <h2 class="font-black text-xl">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´ØªØ±Ùƒ</h2>
                    <button onclick="toggleModal('subModal', false)"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveSub(event)" class="p-8 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input id="sub-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" required class="col-span-2 p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                        <input id="sub-email" type="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" required class="col-span-2 p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                        
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 mr-2">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                            <select id="sub-service" class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                                <option>ChatGPT</option>
                                <option>Netflix</option>
                                <option>YouTube Premium</option>
                                <option>Canva Pro</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 mr-2">Ø§Ù„Ø®Ø·Ø©</label>
                            <select id="sub-plan" class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                                <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                                <option value="yearly">Ø³Ù†ÙˆÙŠ</option>
                                <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (24 Ø³Ø§Ø¹Ø©)</option>
                            </select>
                        </div>

                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 mr-2">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select id="sub-paid" class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                                <option value="true">ØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯ âœ…</option>
                                <option value="false">Ù„Ù… ÙŠØ³Ø¯Ø¯ Ø¨Ø¹Ø¯ âŒ</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 mr-2">Ø§Ù„Ø³Ø¹Ø± ($)</label>
                            <input id="sub-price" type="number" step="0.01" placeholder="0.00" required class="w-full p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                        </div>

                        <input id="sub-date" type="date" class="col-span-2 p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                        <input id="sub-link" placeholder="Ø±Ø§Ø¨Ø· Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="col-span-2 p-3 bg-gray-50 rounded-xl outline-none border border-gray-100">
                    </div>
                    <button type="submit" class="w-full bg-indigo-700 text-white py-4 rounded-2xl font-black text-lg shadow-lg">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹</button>
                </form>
            </div>
        </div>

        <!-- Expense Modal -->
        <div id="expModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden">
                <div class="bg-red-600 p-6 text-white flex justify-between">
                    <h2 class="font-black text-xl">Ø¥Ø¶Ø§ÙØ© ØµØ±ÙÙŠØ©</h2>
                    <button onclick="toggleModal('expModal', false)"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveExp(event)" class="p-6 space-y-4">
                    <input id="exp-title" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†" required class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none">
                    <input id="exp-amount" type="number" step="0.1" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº ($)" required class="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none">
                    <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-xl font-black shadow-lg">ØªØ³Ø¬ÙŠÙ„</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIGURATION
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'arin-store-cloud-v2';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let subs = [];
        let exps = [];
        let currentFilter = 'all';

        // Auth initialization
        onAuthStateChanged(auth, async (user) => {
            if (!user) await signInAnonymously(auth);
            initListeners();
        });

        function initListeners() {
            // Listen to Subscriptions
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'subscriptions'), (snapshot) => {
                subs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubs();
                updateUI();
            });

            // Listen to Expenses
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snapshot) => {
                exps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExps();
                updateUI();
            });
        }

        // Global functions for buttons
        window.toggleModal = (id, show) => {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden', !show);
            modal.classList.toggle('flex', show);
            if(show && id === 'subModal') document.getElementById('sub-date').valueAsDate = new Date();
        };

        window.switchTab = (tab) => {
            document.getElementById('subs-section').classList.toggle('hidden', tab !== 'subs');
            document.getElementById('exps-section').classList.toggle('hidden', tab !== 'exps');
            document.getElementById('btn-subs').classList.toggle('tab-active', tab === 'subs');
            document.getElementById('btn-exps').classList.toggle('tab-active', tab === 'exps');
        };

        window.setFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const active = btn.dataset.filter === f;
                btn.className = `filter-btn px-4 py-1.5 rounded-full text-xs font-bold transition-all ${active ? 'bg-indigo-600 text-white active' : 'bg-gray-100 text-gray-600'}`;
            });
            renderSubs();
        };

        window.saveSub = async (e) => {
            e.preventDefault();
            const start = document.getElementById('sub-date').value;
            const plan = document.getElementById('sub-plan').value;
            const expiry = new Date(start);

            if(plan === 'monthly') expiry.setMonth(expiry.getMonth() + 1);
            else if(plan === 'yearly') expiry.setFullYear(expiry.getFullYear() + 1);
            else if(plan === 'trial') expiry.setHours(expiry.getHours() + 24);

            const data = {
                customerName: document.getElementById('sub-name').value,
                email: document.getElementById('sub-email').value,
                service: document.getElementById('sub-service').value,
                plan: plan,
                isPaid: document.getElementById('sub-paid').value === 'true',
                price: Number(document.getElementById('sub-price').value),
                startDate: start,
                expiryDate: expiry.toISOString(),
                accountLink: document.getElementById('sub-link').value
            };

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subscriptions'), data);
            toggleModal('subModal', false);
            e.target.reset();
        };

        window.saveExp = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                title: document.getElementById('exp-title').value,
                amount: Number(document.getElementById('exp-amount').value),
                date: new Date().toISOString().split('T')[0]
            });
            toggleModal('expModal', false);
            e.target.reset();
        };

        window.deleteItem = async (col, id) => {
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
            }
        };

        window.togglePaid = async (id, currentStatus) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subscriptions', id), {
                isPaid: !currentStatus
            });
        };

        function updateUI() {
            const today = new Date();
            const activeSubs = subs.filter(s => new Date(s.expiryDate) > today);
            const soonSubs = subs.filter(s => {
                const diff = (new Date(s.expiryDate) - today) / (1000 * 3600 * 24);
                return diff > 0 && diff <= 3;
            });
            const trialSubs = subs.filter(s => s.plan === 'trial');
            
            const revenue = subs.reduce((a, b) => a + (b.isPaid ? b.price : 0), 0);
            const expense = exps.reduce((a, b) => a + b.amount, 0);

            document.getElementById('count-active').textContent = activeSubs.length;
            document.getElementById('count-soon').textContent = soonSubs.length;
            document.getElementById('count-trial').textContent = trialSubs.length;
            document.getElementById('stat-profit').textContent = `$${(revenue - expense).toFixed(2)}`;
        }

        window.renderSubs = () => {
            const grid = document.getElementById('subs-grid');
            const search = document.getElementById('search').value.toLowerCase();
            const today = new Date();

            const filtered = subs.filter(s => {
                const matchesSearch = s.customerName.toLowerCase().includes(search) || s.email.toLowerCase().includes(search);
                const expiry = new Date(s.expiryDate);
                const isSoon = (expiry - today) / (1000 * 3600 * 24) <= 3 && (expiry - today) > 0;
                const isActive = expiry > today;

                if (currentFilter === 'active') return matchesSearch && isActive;
                if (currentFilter === 'soon') return matchesSearch && isSoon;
                if (currentFilter === 'unpaid') return matchesSearch && !s.isPaid;
                if (currentFilter === 'trial') return matchesSearch && s.plan === 'trial';
                return matchesSearch;
            });

            grid.innerHTML = filtered.map(s => {
                const isExpired = new Date(s.expiryDate) < today;
                const diff = Math.ceil((new Date(s.expiryDate) - today) / (1000 * 3600 * 24));
                const isSoon = diff <= 3 && diff > 0;

                return `
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden">
                        ${isSoon ? '<div class="absolute top-0 left-0 bg-orange-500 text-white text-[9px] px-3 py-1 font-bold">Ù‚Ø±Ø¨ ÙŠÙ†ØªÙ‡ÙŠ</div>' : ''}
                        ${s.plan === 'trial' ? '<div class="absolute top-0 right-0 bg-blue-500 text-white text-[9px] px-3 py-1 font-bold">ØªØ¬Ø±ÙŠØ¨ÙŠ</div>' : ''}
                        
                        <div class="flex justify-between items-start mb-4 pt-2">
                            <div class="flex gap-3">
                                <div class="w-12 h-12 bg-gray-100 text-indigo-700 rounded-2xl flex items-center justify-center font-black text-xl">${s.customerName[0]}</div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-sm">${s.customerName}</h4>
                                    <p class="text-[10px] text-gray-400">${s.email}</p>
                                </div>
                            </div>
                            <div class="text-left">
                                <span class="font-black text-lg ${s.isPaid ? 'text-emerald-600' : 'text-red-500'}">$${s.price}</span>
                                <div onclick="togglePaid('${s.id}', ${s.isPaid})" class="cursor-pointer">
                                    ${s.isPaid ? '<span class="status-badge bg-emerald-100 text-emerald-700">Ù…Ø¯ÙÙˆØ¹ âœ…</span>' : '<span class="status-badge bg-red-100 text-red-700">Ù„Ù… ÙŠØ³Ø¯Ø¯ âŒ</span>'}
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="bg-indigo-50 text-indigo-700 text-[10px] px-2 py-1 rounded-lg font-bold">${s.service}</span>
                            <span class="bg-gray-50 text-gray-500 text-[10px] px-2 py-1 rounded-lg">
                                <i class="far fa-clock ml-1"></i> ÙŠÙ†ØªÙ‡ÙŠ: ${new Date(s.expiryDate).toLocaleDateString('ar-EG')}
                            </span>
                        </div>

                        <div class="flex gap-2 pt-4 border-t border-dashed border-gray-50">
                            <button onclick="window.open('https://wa.me/?text=${encodeURIComponent('Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + s.customerName + 'ØŒ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ ' + s.service + ' ÙŠÙ†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ' + new Date(s.expiryDate).toLocaleDateString() + '. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.')}')" class="flex-1 bg-green-500 text-white py-2 rounded-xl text-xs font-bold hover:bg-green-600"><i class="fab fa-whatsapp ml-1"></i> ØªØ°ÙƒÙŠØ±</button>
                            ${s.accountLink ? `<a href="${s.accountLink}" target="_blank" class="p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100"><i class="fas fa-link"></i></a>` : ''}
                            <button onclick="deleteItem('subscriptions', '${s.id}')" class="p-2 text-gray-200 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        function renderExps() {
            const list = document.getElementById('exps-list');
            list.innerHTML = `
                <table class="w-full text-right border-collapse mt-4">
                    <thead class="text-xs text-gray-400 font-bold border-b">
                        <tr><th class="p-3">Ø§Ù„Ø¨ÙŠØ§Ù†</th><th class="p-3 text-center">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        ${exps.map(e => `
                            <tr class="text-sm">
                                <td class="p-3"><p class="font-bold text-gray-700">${e.title}</p><p class="text-[9px] text-gray-400">${e.date}</p></td>
                                <td class="p-3 text-center font-black text-red-500">$${e.amount}</td>
                                <td class="p-3 text-center">
                                    <button onclick="deleteItem('expenses', '${e.id}')" class="text-gray-200 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
    </script>
</body>
</html>


