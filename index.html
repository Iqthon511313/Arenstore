<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>أرين ستور - إدارة الاشتراكات</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;800&display=swap');
        :root { --bg-dark: #05070A; --card-dark: #0A0F19; --accent-blue: #3B82F6; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-dark); -webkit-tap-highlight-color: transparent; color: #e2e8f0; }
        .active-scale:active { transform: scale(0.95); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect } = React;

        // استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // بيانات مشروعك التي أرسلتها
        const firebaseConfig = {
            apiKey: "AIzaSyAKok61chnRv9_-QQeQ-TP9WkZwc8cqqac",
            authDomain: "arenstore-d61ce.firebaseapp.com",
            projectId: "arenstore-d61ce",
            storageBucket: "arenstore-d61ce.firebasestorage.app",
            messagingSenderId: "5224012268",
            appId: "1:5224012268:web:11d11411b57247a87f08c9",
            measurementId: "G-TEW8WWXFFG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // نستخدم معرف ثابت للمجموعة لضمان ظهور البيانات للجميع
        const collectionName = "aren_subscriptions";

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [subscriptions, setSubscriptions] = useState([]);
            const [activeTab, setActiveTab] = useState('subs');
            const [isSubModalOpen, setIsSubModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [loading, setLoading] = useState(true);

            const [subForm, setSubForm] = useState({
                customerName: '', email: '', contactInfo: '', serviceName: 'ChatGPT Plus',
                plan: 'monthly', customDays: '', price: ''
            });

            useEffect(() => {
                // تفعيل الدخول المجهول (تأكد من تفعيله في Firebase Console كما شرحت لك)
                signInAnonymously(auth).catch(err => console.error("Auth Error:", err));
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                // جلب البيانات من السحابة مباشرة
                const subsRef = collection(db, collectionName);
                const unsub = onSnapshot(subsRef, (snap) => {
                    setSubscriptions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if(err.code === 'permission-denied') {
                        alert("خطأ: يرجى تفعيل Firestore وتعيين القواعد (Rules) إلى Test Mode في Firebase Console.");
                    }
                });
                return () => unsub();
            }, [user]);

            const getDaysRemaining = (expiryDate) => {
                const diff = new Date(expiryDate) - new Date();
                return Math.ceil(diff / (1000 * 60 * 60 * 24));
            };

            const saveSubscription = async (e) => {
                e.preventDefault();
                if (!user) return;
                
                let expiryDate = new Date();
                if(subForm.plan === 'monthly') expiryDate.setMonth(expiryDate.getMonth() + 1);
                else if(subForm.plan === 'yearly') expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                else if(subForm.plan === 'custom' && subForm.customDays) expiryDate.setDate(expiryDate.getDate() + parseInt(subForm.customDays));
                
                const data = { 
                    ...subForm, 
                    expiryDate: expiryDate.toISOString().split('T')[0], 
                    price: Number(subForm.price), 
                    updatedAt: Date.now() 
                };
                
                try {
                    if (editingItem) {
                        await updateDoc(doc(db, collectionName, editingItem.id), data);
                    } else {
                        await addDoc(collection(db, collectionName), data);
                    }
                    setIsSubModalOpen(false);
                    setEditingItem(null);
                    setSubForm({ customerName: '', email: '', contactInfo: '', serviceName: 'ChatGPT Plus', plan: 'monthly', customDays: '', price: '' });
                } catch (err) { 
                    alert("حدث خطأ أثناء الحفظ بالسحابة"); 
                }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-[#05070A]">
                    <div className="text-center space-y-4">
                        <div className="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                        <p className="text-blue-500 font-bold animate-pulse">جاري الاتصال بـ Aren Store...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#05070A] pb-24">
                    {/* Header */}
                    <header className="p-5 flex justify-between items-center sticky top-0 bg-[#05070A]/80 backdrop-blur-md z-40 border-b border-white/5">
                        <div>
                            <h1 className="text-xl font-extrabold text-white tracking-tight">AREN STORE</h1>
                            <p className="text-[10px] text-emerald-500 font-black uppercase tracking-widest flex items-center gap-1">
                                <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> سحابي نشط
                            </p>
                        </div>
                        <button onClick={() => setIsSubModalOpen(true)} className="w-11 h-11 bg-blue-600 rounded-2xl flex items-center justify-center text-white active-scale shadow-lg shadow-blue-600/30">
                            <Icon name="plus" size={24} />
                        </button>
                    </header>

                    <main className="p-4 space-y-4">
                        {activeTab === 'dashboard' ? (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-8 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="opacity-80 text-xs font-bold mb-1">إجمالي المبيعات</p>
                                        <h2 className="text-4xl font-black">${subscriptions.reduce((a,b)=>a+(Number(b.price)||0),0)}</h2>
                                    </div>
                                    <Icon name="zap" size={100} className="absolute -bottom-4 -left-4 opacity-10 rotate-12" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-[#0A0F19] p-6 rounded-[2rem] border border-white/5 shadow-xl">
                                        <p className="text-slate-500 text-[10px] font-black uppercase mb-1">الزبائن</p>
                                        <p className="text-3xl font-black text-white">{subscriptions.length}</p>
                                    </div>
                                    <div className="bg-[#0A0F19] p-6 rounded-[2rem] border border-white/5 shadow-xl">
                                        <p className="text-slate-500 text-[10px] font-black uppercase mb-1">قرب الانتهاء</p>
                                        <p className="text-3xl font-black text-amber-500">{subscriptions.filter(s => getDaysRemaining(s.expiryDate) <= 7).length}</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4">
                                {subscriptions.length === 0 ? (
                                    <div className="text-center py-20 opacity-40">
                                        <Icon name="users" size={48} className="mx-auto mb-4" />
                                        <p className="font-bold italic">قاعدة البيانات فارغة حالياً</p>
                                    </div>
                                ) : (
                                    subscriptions.map(s => {
                                        const days = getDaysRemaining(s.expiryDate);
                                        return (
                                            <div key={s.id} className="bg-[#0A0F19] p-5 rounded-[2.2rem] border border-white/5 shadow-xl space-y-4">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="font-black text-white text-lg leading-none mb-1">{s.customerName}</h3>
                                                        <p className="text-[11px] text-blue-500 font-bold">{s.serviceName} • ${s.price}</p>
                                                    </div>
                                                    <span className={`text-[10px] font-black px-3 py-1 rounded-full ${days < 3 ? 'bg-rose-500/10 text-rose-500' : 'bg-emerald-500/10 text-emerald-500'}`}>
                                                        {days} يوم متبقي
                                                    </span>
                                                </div>
                                                <div className="text-[11px] text-slate-500 space-y-0.5">
                                                    <p className="flex items-center gap-1"><Icon name="mail" size={10}/> {s.email || 'لا يوجد إيميل'}</p>
                                                    <p className="flex items-center gap-1 text-slate-400 font-bold"><Icon name="link" size={10}/> {s.contactInfo}</p>
                                                </div>
                                                <div className="flex items-center justify-between pt-3 border-t border-white/5 gap-2">
                                                    <button onClick={() => { setEditingItem(s); setSubForm(s); setIsSubModalOpen(true); }} className="flex-1 py-3 bg-white/5 rounded-xl text-slate-400 active-scale text-xs font-bold flex items-center justify-center gap-2">
                                                        <Icon name="edit-2" size={14}/> تعديل
                                                    </button>
                                                    <button onClick={() => {
                                                        const msg = `أهلاً ${s.customerName}، تذكير من أرين ستور: اشتراكك في ${s.serviceName} ينتهي بتاريخ ${s.expiryDate}.`;
                                                        window.open(`https://wa.me/${s.contactInfo.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`);
                                                    }} className="flex-1 py-3 bg-blue-600/10 rounded-xl text-blue-500 active-scale text-xs font-bold flex items-center justify-center gap-2">
                                                        <Icon name="send" size={14}/> تذكير
                                                    </button>
                                                    <button onClick={() => { if(confirm('هل أنت متأكد؟')) deleteDoc(doc(db, collectionName, s.id)) }} className="p-3 bg-rose-500/10 rounded-xl text-rose-500 active-scale">
                                                        <Icon name="trash-2" size={14}/>
                                                    </button>
                                                </div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-[#0A0F19]/90 backdrop-blur-2xl border-t border-white/5 flex justify-around p-4 safe-area-bottom z-50">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'dashboard' ? 'text-blue-500 scale-110' : 'text-slate-600'}`}>
                            <Icon name="layout-grid" size={24} />
                            <span className="text-[10px] font-black">الرئيسية</span>
                        </button>
                        <button onClick={() => setActiveTab('subs')} className={`flex flex-col items-center gap-1 transition-all ${activeTab === 'subs' ? 'text-blue-500 scale-110' : 'text-slate-600'}`}>
                            <Icon name="users" size={24} />
                            <span className="text-[10px] font-black">المشتركين</span>
                        </button>
                    </nav>

                    {/* Modal */}
                    {isSubModalOpen && (
                        <div className="fixed inset-0 bg-black/95 z-[100] p-4 flex flex-col justify-end lg:justify-center lg:items-center">
                            <div className="bg-[#0A0F19] w-full max-w-lg rounded-t-[3rem] lg:rounded-[3rem] p-8 pb-12 space-y-6 animate-in slide-in-from-bottom-full duration-300 shadow-3xl">
                                <div className="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-2 lg:hidden" onClick={() => setIsSubModalOpen(false)}></div>
                                <h2 className="text-2xl font-black text-white text-center tracking-tight">{editingItem ? 'تعديل البيانات' : 'إضافة مشترك جديد'}</h2>
                                <form onSubmit={saveSubscription} className="space-y-4">
                                    <div className="space-y-4 max-h-[60vh] overflow-y-auto px-1 custom-scrollbar">
                                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none focus:border-blue-600 transition-all font-bold" placeholder="اسم المشترك الكامل" value={subForm.customerName} onChange={e=>setSubForm({...subForm, customerName:e.target.value})} required />
                                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none" placeholder="البريد الإلكتروني (اختياري)" type="email" value={subForm.email} onChange={e=>setSubForm({...subForm, email:e.target.value})} />
                                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none font-bold" placeholder="رابط الحساب أو رقم الهاتف" value={subForm.contactInfo} onChange={e=>setSubForm({...subForm, contactInfo:e.target.value})} required />
                                        <div className="grid grid-cols-2 gap-3">
                                            <input className="bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none font-bold" placeholder="السعر $" type="number" value={subForm.price} onChange={e=>setSubForm({...subForm, price:e.target.value})} required />
                                            <select className="bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none font-bold appearance-none" value={subForm.plan} onChange={e=>setSubForm({...subForm, plan:e.target.value})}>
                                                <option value="monthly">باقة شهرية</option>
                                                <option value="yearly">باقة سنوية</option>
                                                <option value="custom">أيام مخصصة</option>
                                            </select>
                                        </div>
                                        {subForm.plan === 'custom' && (
                                            <input className="w-full bg-blue-600/10 border border-blue-600/30 p-4 rounded-2xl text-blue-400 outline-none font-bold" placeholder="أدخل عدد الأيام..." type="number" value={subForm.customDays} onChange={e=>setSubForm({...subForm, customDays:e.target.value})} required />
                                        )}
                                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-white outline-none font-bold" placeholder="نوع الخدمة (مثلاً: نتفلكس)" value={subForm.serviceName} onChange={e=>setSubForm({...subForm, serviceName:e.target.value})} required />
                                    </div>
                                    <button className="w-full bg-blue-600 text-white py-5 rounded-[1.8rem] font-black shadow-xl shadow-blue-600/30 active-scale transition-all text-lg tracking-tight">إتمام الحفظ السحابي</button>
                                    <button type="button" onClick={() => setIsSubModalOpen(false)} className="w-full text-slate-500 font-bold py-2">تجاهل</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

